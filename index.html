<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<title>El cuervo Turr√°n</title>
<style>
:root{--bg:#0b1220;--ink:#eaf2ff;--panel:#0f1830;--btn:#1f2b46;--jump:#2e7be6;--grass:#59cf63;--dirt:#6a4a35}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
#wrap{min-height:100%;display:flex;flex-direction:column;align-items:center;gap:10px;padding:12px}
#hud{width:100%;max-width:980px;display:flex;justify-content:space-between;font-weight:800}
#stage{width:100%;max-width:980px;display:flex;flex-direction:column;align-items:center;gap:12px}
canvas{width:100%;height:auto;background:#78c7ff;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
#pad{display:flex;gap:16px;justify-content:center;width:100%}
#pad button{width:min(22vw,92px);height:min(22vw,92px);border:0;border-radius:20px;background:var(--btn);color:#fff;font-size:min(8vw,30px);box-shadow:0 8px 22px rgba(0,0,0,.25)}
#pad #jump{background:var(--jump)}
.overlay{position:fixed;inset:0;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:16px;background:rgba(0,0,0,.92);z-index:20}
#intro img{max-width:min(92vw,560px);max-height:50vh;object-fit:contain;border-radius:14px;box-shadow:0 16px 36px rgba(0,0,0,.5);margin-bottom:10px}
#intro h1{font-size:clamp(28px,7vw,52px);margin:0 0 12px}
.cta{font-size:clamp(18px,4.5vw,22px);padding:.8em 1.4em;border-radius:12px;border:0;background:#00c08a;color:#052516;box-shadow:0 10px 24px rgba(0,0,0,.35)}
#gameover h1{font-size:clamp(28px,8vw,54px);color:#ff3a3a;margin:0 0 12px;text-align:center}
#mute{position:fixed;top:10px;right:10px;z-index:25;border:0;padding:8px 12px;border-radius:10px;background:#263455;color:#fff;opacity:.9}
</style>
</head>
<body>
<button id="mute" aria-label="Silenciar">üîä</button>

<!-- PORTADA -->
<div id="intro" class="overlay" role="dialog" aria-modal="true">
  <img id="introImg" src="turran_moto.png?v=5" alt="Turr√°n en moto" onerror="this.style.display='none'">
  <h1>EL CUERVO TURR√ÅN</h1>
  <button class="cta" id="startBtn">Comenzar</button>
</div>

<!-- GAME OVER -->
<div id="gameover" class="overlay" style="display:none">
  <h1>GAME OVER<br>ESTO Y LO OTRO</h1>
  <button class="cta" id="againBtn">Reintentar</button>
</div>

<div id="wrap">
  <div id="hud"><div>Plumas: <span id="score">0</span></div><div>Vidas: <span id="lives">3</span></div></div>
  <div id="stage">
    <canvas id="game" width="900" height="540"></canvas>
    <div id="pad">
      <button id="left" aria-label="Izquierda">‚óÄ</button>
      <button id="jump" aria-label="Saltar">‚§í</button>
      <button id="right" aria-label="Derecha">‚ñ∂</button>
    </div>
  </div>
</div>

<script>
/* ---------- Canvas responsive ---------- */
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d',{alpha:false});
function fit(){ const w=document.getElementById('stage').clientWidth; canvas.width=w; canvas.height=Math.round(w*0.6); }
addEventListener('resize',fit); addEventListener('orientationchange',fit); fit();

/* ---------- Assets ---------- */
const imgPlayer=new Image(); imgPlayer.src='turran_sprite.png?v=5';
const imgEnemy=new Image(); let enemyReady=false;
(function findEnemy(){
  const list=['txibiri.png','txibiri.jpg','txibiri.jpeg','txibiri.webp'];
  (function tryNext(i=0){
    if(i>=list.length){enemyReady=false;return;}
    const u=list[i]+'?v=5';
    imgEnemy.onload=()=>enemyReady=true;
    imgEnemy.onerror=()=>tryNext(i+1);
    imgEnemy.src=u;
  })();
})();

/* ---------- Estado ---------- */
let started=false,running=false, t=0;
let score=0,lives=3; const scoreEl=q('#score'), livesEl=q('#lives');
let camX=0, groundY=Math.round(canvas.height*0.82);
const G=0.55;
const P={x:150,y:0,vx:0,vy:0,dir:1,onGround:true,anim:0,w:64,h:64,scale:3.2}; // SIEMPRE con margen a la izquierda
const enemies=[], bubbles=[];
function q(s){return document.querySelector(s);}
function resetPlayer(){
  P.scale=Math.max(3.0, canvas.height/170);
  groundY=Math.round(canvas.height*0.82);
  P.x=150; P.y=groundY-P.h*P.scale; P.vx=0; P.vy=0; P.onGround=true; P.dir=1; P.anim=0;
  camX=0; // no empuja a la derecha
}

/* ---------- Controles ---------- */
const k=Object.create(null), touch={left:false,right:false,jump:false};
addEventListener('keydown',e=>k[e.key.toLowerCase()]=true);
addEventListener('keyup',e=>k[e.key.toLowerCase()]=false);
for(const id of['left','right','jump']){
  const el=document.getElementById(id);
  el.addEventListener('touchstart',e=>{e.preventDefault();touch[id]=true;},{passive:false});
  el.addEventListener('touchend',e=>{e.preventDefault();touch[id]=false;},{passive:false});
  el.addEventListener('mousedown',()=>touch[id]=true);
  el.addEventListener('mouseup',()=>touch[id]=false);
}

/* ---------- M√∫sica chiptune simple ---------- */
let AC=null, lead=null, bass=null, musicOn=true;
function mk(type,g){const o=AC.createOscillator(), a=AC.createGain();o.type=type;a.gain.value=g;o.connect(a).connect(AC.destination);o.start();return{o,a}}
function startMusic(){
  if(!musicOn) return;
  if(!AC){try{AC=new (window.AudioContext||window.webkitAudioContext)()}catch{}}
  if(!AC||lead) return;
  const L=mk('square',0.06), B=mk('triangle',0.04); lead=L.o; bass=B.o;
  let i=0; const scale=[262,330,392,523,392,330,294,330];
  (function loop(){
    if(!lead) return;
    const tt=AC.currentTime; lead.frequency.setValueAtTime(scale[i%scale.length],tt);
    bass.frequency.setValueAtTime(110+((i>>2)%4)*14,tt); i++; setTimeout(loop,210);
  })();
}
function stopMusic(){ if(lead){try{lead.stop()}catch{}; lead.disconnect(); lead=null} if(bass){try{bass.stop()}catch{}; bass.disconnect(); bass=null} }
q('#mute').onclick=()=>{ musicOn=!musicOn; q('#mute').textContent=musicOn?'üîä':'üîá'; if(!musicOn) stopMusic(); else if(started) startMusic(); }
document.addEventListener('visibilitychange',()=>{ if(document.hidden) stopMusic(); else if(started) startMusic(); });
addEventListener('pagehide',stopMusic); addEventListener('beforeunload',stopMusic);

/* ---------- UI ---------- */
q('#startBtn').onclick=()=>{ started=true; q('#intro').style.display='none'; score=0;lives=3;scoreEl.textContent=0;livesEl.textContent=3; resetWorld(); startMusic(); running=true; requestAnimationFrame(frame); };
q('#againBtn').onclick=()=>{ q('#gameover').style.display='none'; score=0;lives=3;scoreEl.textContent=0;livesEl.textContent=3; resetWorld(); startMusic(); running=true; requestAnimationFrame(frame); };
addEventListener('keydown',e=>{ if(!started&&(e.key===' '||e.key==='Enter'||e.key==='ArrowUp')) q('#startBtn').click(); });

function resetWorld(){ enemies.length=0; nextEnemy=120; resetPlayer(); t=0; }
function gameOver(){ running=false; stopMusic(); q('#gameover').style.display='flex'; }

/* ---------- Util ---------- */
function say(x,y,txt){ bubbles.push({x,y,text:txt,age:0}); }
function rects(a,b){return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y}

/* ---------- Update / Draw ---------- */
let nextEnemy=120;
function update(){
  const left = k['arrowleft']||k['a']||touch.left;
  const right= k['arrowright']||k['d']||touch.right;
  const wantsJump = k[' ']||k['w']||k['arrowup']||touch.jump;
  const SPEED=3.2;

  P.vx=(right?SPEED:0)-(left?SPEED:0);
  if(left) P.dir=-1; if(right) P.dir=1;
  if(wantsJump && P.onGround){ P.vy=-11; P.onGround=false; say(P.x,P.y-20,'PARAPARAA!!'); }

  P.vy+=0.55; P.x+=P.vx; P.y+=P.vy;
  const feet=P.y+P.h*P.scale;
  if(feet>groundY){ P.y=groundY-P.h*P.scale; P.vy=0; P.onGround=true; }

  /* C√°mara con zona muerta: mantiene SIEMPRE margen a la izquierda */
  const leftEdge=140, rightEdge=Math.round(canvas.width*0.58);
  const px=P.x-camX;
  if(px>rightEdge) camX=P.x-rightEdge;
  if(px<leftEdge)  camX=P.x-leftEdge;
  if(camX<0) camX=0;

  /* Enemigos: m√°s lentos, grandes y lejos (para verlos venir) */
  nextEnemy--;
  if(nextEnemy<=0){
    const size=Math.round(96+Math.random()*56);
    const dist=canvas.width+260+Math.random()*260;
    const vel=-(1.2+Math.random()*1.2);
    enemies.push({x:camX+dist,y:groundY-size,w:size,h:size,vx:vel,alive:true});
    nextEnemy=120+(Math.random()*120|0);
  }
  for(const e of enemies) if(e.alive) e.x+=e.vx;

  /* Colisiones */
  const pr={x:P.x,y:P.y,w:P.w*P.scale,h:P.h*P.scale};
  for(const e of enemies){
    if(!e.alive) continue;
    const er={x:e.x,y:e.y,w:e.w,h:e.h};
    if(rects(pr,er)){
      if(P.vy>1){ e.alive=false; score+=10; scoreEl.textContent=score; P.vy=-8; say(e.x,e.y-10,'¬°AY!'); }
      else { lives--; livesEl.textContent=lives; say(P.x,P.y-16,'¬°AU!'); P.x-=28; P.vy=-7; if(lives<=0) gameOver(); }
    }
  }

  for(const b of bubbles){ b.age+=0.03; }
  while(bubbles.length && bubbles[0].age>2.2) bubbles.shift();
}

function draw(){
  // cielo
  const g=ctx.createLinearGradient(0,0,0,canvas.height); g.addColorStop(0,'#8fd1ff'); g.addColorStop(1,'#58aaf0');
  ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
  // nubes
  ctx.fillStyle='rgba(255,255,255,.95)';
  for(let i=0;i<5;i++){ const x=((i*260 + (t*0.35)) - camX*0.1)%(canvas.width+320)-160; const y=50+(i%3)*30;
    ctx.beginPath(); ctx.ellipse(x,y,44,18,0,0,7); ctx.ellipse(x+30,y+6,34,14,0,0,7); ctx.fill();
  }
  // suelo
  const groundY=Math.round(canvas.height*0.82);
  ctx.fillStyle=getCSS('--dirt'); ctx.fillRect(0,groundY-18,canvas.width,18);
  ctx.fillStyle=getCSS('--grass'); ctx.fillRect(0,groundY-28,canvas.width,10);

  // enemigos (c√≠rculo con la foto si existe)
  for(const e of enemies){
    if(!e.alive) continue;
    const x=Math.floor(e.x-camX), y=e.y, r=e.w/2;
    if(enemyReady){
      ctx.save(); ctx.beginPath(); ctx.arc(x+r,y+r,r,0,7); ctx.clip();
      ctx.drawImage(imgEnemy,x,y,e.w,e.h); ctx.restore();
      ctx.strokeStyle='#fff'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(x+r,y+r,r,0,7); ctx.stroke();
    }else{ ctx.fillStyle='#c33'; ctx.fillRect(x,y,e.w,e.h); }
  }

  // Turr√°n (grande, sin cortarse)
  if(imgPlayer.complete){
    const fw=64,fh=64, sx=(P.anim%4)*fw, sy=0;
    const dw=fw*P.scale, dh=fh*P.scale;
    const screenX=Math.floor(P.x-camX);              // posici√≥n en pantalla
    const dx = Math.max(0, screenX + (P.dir===-1?dw:0)); // evita dibujar fuera del lienzo
    const dy = Math.floor(P.y);
    ctx.save(); ctx.translate(dx,dy); ctx.scale(P.dir,1);
    ctx.drawImage(imgPlayer,sx,sy,fw,fh,0,0,dw,dh); ctx.restore();
  }

  // bocadillos
  ctx.font='bold 24px system-ui,Segoe UI,Roboto';
  for(const b of bubbles){
    const alpha=Math.max(0,1-(b.age-0.6)/1.2); ctx.globalAlpha=alpha;
    const x=Math.floor(b.x-camX), y=Math.floor(b.y-42-b.age*22), w=ctx.measureText(b.text).width+18;
    ctx.fillStyle='#fff'; ctx.fillRect(x-w/2,y,w,36);
    ctx.fillStyle='#111'; ctx.fillText(b.text,x-w/2+9,y+7);
    ctx.globalAlpha=1;
  }
  t++;
}
function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name); }

function frame(){ if(!running) return; update(); draw(); requestAnimationFrame(frame); }

/* resize -> reubicar sin cortar */
addEventListener('resize',()=>{ fit(); resetPlayer(); });
</script>
</body>
</html>
